<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="house.tonightDiscountDao" >
  <resultMap id="BaseResultMap" type="com.ziroom.minsu.entity.house.TonightDiscountEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 10 15:33:32 CST 2017.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="fid" property="fid" jdbcType="VARCHAR" />
    <result column="house_fid" property="houseFid" jdbcType="VARCHAR" />
    <result column="room_fid" property="roomFid" jdbcType="VARCHAR" />
    <result column="rent_way" property="rentWay" jdbcType="INTEGER" />
    <result column="discount" property="discount" jdbcType="DECIMAL" />
    <result column="discount_source" property="discountSource" jdbcType="TINYINT" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
    <result column="create_uid" property="createUid" jdbcType="VARCHAR" />
    <result column="discount_date" property="discountDate" jdbcType="TIMESTAMP" />
    <result column="last_modify_date" property="lastModifyDate" jdbcType="TIMESTAMP" />
    <result column="last_modify_uid" property="lastModifyUid" jdbcType="VARCHAR" />
    <result column="is_del" property="isDel" jdbcType="INTEGER" />
  </resultMap>
  
  <resultMap id="remindLandlordMap" type="com.ziroom.minsu.entity.house.HouseBaseMsgEntity">
    <result column="landlord_uid" jdbcType="VARCHAR" property="landlordUid" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 10 15:33:32 CST 2017.
    -->
    id, fid, house_fid, room_fid, rent_way, discount, discount_source, create_date, create_uid, 
    discount_date, start_time, end_time, last_modify_date, last_modify_uid, is_del
  </sql>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 10 15:33:32 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from t_house_tonight_discount
    where id = #{id,jdbcType=INTEGER}
  </select>

  <select id="findTonightDiscountByCondition" parameterType="com.ziroom.minsu.entity.house.TonightDiscountEntity" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM `minsu_house_db`.`t_house_tonight_discount` thtd
    WHERE
    thtd.house_fid = #{houseFid,jdbcType=VARCHAR}
    <choose>
      <when test="discountDate != null and discountDate !=''">
        AND thtd.discount_date = #{discountDate,jdbcType=TIMESTAMP}
      </when>
      <otherwise>
          AND thtd.discount_date = CURRENT_DATE
      </otherwise>
    </choose>
    <if test="roomFid != null and roomFid !=''" >
      AND thtd.room_fid = #{roomFid,jdbcType=VARCHAR}
    </if>
    <if test="rentWay != null" >
      AND thtd.rent_way = #{rentWay,jdbcType=INTEGER}
    </if>
    AND thtd.is_del = 0
  </select>

  <!--根据房源id查询今夜特价 整租-->
  <select id="findTonightDiscountEntire" parameterType="com.ziroom.minsu.entity.house.TonightDiscountEntity" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM `minsu_house_db`.`t_house_tonight_discount` thtd
    WHERE
    thtd.house_fid = #{houseFid,jdbcType=VARCHAR}
    AND thtd.discount_date = CURRENT_DATE
    AND thtd.rent_way = 0
    AND thtd.is_del = 0
  </select>

  <!--根据房源id查询今夜特价 分租-->
  <select id="findTonightDiscountSub" parameterType="com.ziroom.minsu.entity.house.TonightDiscountEntity" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM `minsu_house_db`.`t_house_tonight_discount` thtd
    WHERE
    thtd.room_fid = #{roomFid,jdbcType=VARCHAR}
    AND thtd.discount_date = CURRENT_DATE
    AND thtd.rent_way = 1
    AND thtd.is_del = 0
  </select>

  <insert id="insertTonightDiscount" parameterType="com.ziroom.minsu.entity.house.TonightDiscountEntity" >
    <!--
     插入今夜特价
    -->
    insert into t_house_tonight_discount
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="fid != null" >
        fid,
      </if>
      <if test="houseFid != null" >
        house_fid,
      </if>
      <if test="roomFid != null" >
        room_fid,
      </if>
      <if test="rentWay != null" >
        rent_way,
      </if>
      <if test="discount != null" >
        discount,
      </if>
      <if test="discountSource != null" >
        discount_source,
      </if>
      <if test="createDate != null" >
        create_date,
      </if>
      <if test="createUid != null" >
        create_uid,
      </if>
      discount_date,
      <if test="startTime != null" >
        start_time,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
      <if test="lastModifyDate != null" >
        last_modify_date,
      </if>
      <if test="lastModifyUid != null" >
        last_modify_uid,
      </if>
      <if test="isDel != null" >
        is_del,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="fid != null" >
        #{fid,jdbcType=VARCHAR},
      </if>
      <if test="houseFid != null" >
        #{houseFid,jdbcType=VARCHAR},
      </if>
      <if test="roomFid != null" >
        #{roomFid,jdbcType=VARCHAR},
      </if>
      <if test="rentWay != null" >
        #{rentWay,jdbcType=INTEGER},
      </if>
      <if test="discount != null" >
        #{discount,jdbcType=DECIMAL},
      </if>
      <if test="discountSource != null" >
        #{discountSource,jdbcType=TINYINT},
      </if>
      <if test="createDate != null" >
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUid != null" >
        #{createUid,jdbcType=VARCHAR},
      </if>
        CURRENT_DATE ,
      <if test="startTime != null" >
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastModifyDate != null" >
        #{lastModifyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastModifyUid != null" >
        #{lastModifyUid,jdbcType=VARCHAR},
      </if>
      <if test="isDel != null" >
        #{isDel,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
 
  
 
  <update id="updateByPrimaryKeySelective" parameterType="com.ziroom.minsu.entity.house.TonightDiscountEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 10 15:33:32 CST 2017.
    -->
    update t_house_tonight_discount
    <set >
      <if test="fid != null" >
        fid = #{fid,jdbcType=VARCHAR},
      </if>
      <if test="houseFid != null" >
        house_fid = #{houseFid,jdbcType=VARCHAR},
      </if>
      <if test="roomFid != null" >
        room_fid = #{roomFid,jdbcType=VARCHAR},
      </if>
      <if test="rentWay != null" >
        rent_way = #{rentWay,jdbcType=INTEGER},
      </if>
      <if test="discount != null" >
        discount = #{discount,jdbcType=DECIMAL},
      </if>
      <if test="discountSource != null" >
        discount_source = #{discountSource,jdbcType=TINYINT},
      </if>
      <if test="createDate != null" >
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createUid != null" >
        create_uid = #{createUid,jdbcType=VARCHAR},
      </if>
      <if test="discountDate != null" >
        discount_date = #{discountDate,jdbcType=TIMESTAMP},
      </if>
      <if test="startTime != null" >
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastModifyUid != null" >
        last_modify_uid = #{lastModifyUid,jdbcType=VARCHAR},
      </if>
      <if test="isDel != null" >
        is_del = #{isDel,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  
  <!-- 查询要提醒的房东uid -->
  <select id="findRemindLandlordUid"  parameterType="map"  resultMap="remindLandlordMap">
  	SELECT temp.landlord_uid FROM 
	(SELECT tbm.landlord_uid FROM `t_house_base_msg` tbm
	LEFT JOIN (SELECT fid,house_fid FROM `t_house_tonight_discount` WHERE rent_way=0 AND discount_date=#{lockTime,jdbcType=VARCHAR}) ttd ON tbm.`fid`=ttd.`house_fid`
	WHERE tbm.house_status=40 AND tbm.`rent_way`=0 AND ttd.`fid` IS NULL 
	<if test="null != houseFids and houseFids.size > 0">
	AND tbm.fid NOT IN
	 <foreach item="item" index="index" collection="houseFids" open="(" separator="," close=")">
	    #{item}
	 </foreach>
	 </if>
	UNION ALL
	SELECT tbm.landlord_uid FROM `t_house_room_msg` tr LEFT JOIN `t_house_base_msg` tbm 
	ON tr.house_base_fid=tbm.fid
	LEFT JOIN (SELECT fid,room_fid FROM `t_house_tonight_discount` WHERE rent_way=1 AND discount_date=#{lockTime,jdbcType=VARCHAR}) ttd ON ttd.`room_fid`=tr.fid
	WHERE tbm.rent_way=1 AND tr.room_status=40  AND ttd.`fid` IS NULL 
	<if test="null != roomFids and roomFids.size > 0">
	AND tr.fid NOT IN
    <foreach item="item" index="index" collection="roomFids" open="(" separator="," close=")">
	    #{item}
	</foreach>
	</if>
	) temp
	GROUP BY temp.landlord_uid
  </select>
</mapper>
