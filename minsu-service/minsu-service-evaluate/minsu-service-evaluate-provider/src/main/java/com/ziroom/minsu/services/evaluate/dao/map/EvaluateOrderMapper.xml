<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="evaluate.evaluateOrderDao" >
  <resultMap id="BaseResultMap" type="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="fid" property="fid" jdbcType="VARCHAR" />
    <result column="order_sn" property="orderSn" jdbcType="VARCHAR" />
    <result column="eva_statu" property="evaStatu" jdbcType="INTEGER" />
    <result column="eva_user_uid" property="evaUserUid" jdbcType="VARCHAR" />
    <result column="rated_user_uid" property="ratedUserUid" jdbcType="VARCHAR" />
    <result column="eva_user_type" property="evaUserType" jdbcType="INTEGER" />
    <result column="house_fid" property="houseFid" jdbcType="VARCHAR" />
    <result column="room_fid" property="roomFid" jdbcType="VARCHAR" />
    <result column="bed_fid" property="bedFid" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="last_modify_date" property="lastModifyDate" jdbcType="TIMESTAMP" />
    <result column="rent_way" property="rentWay" jdbcType="INTEGER" />
    <result column="order_eva_flag" property="orderEvaFlag" jdbcType="INTEGER" />
  </resultMap>
    <!--查找订单号-->
    <resultMap id="orderResultMap" type="com.ziroom.minsu.services.evaluate.entity.EvaluateOrderItemVo" >
        <result column="order_sn" property="orderSn" jdbcType="VARCHAR" />
    </resultMap>
     <!--房东评价列表 相关vo-->
    <resultMap type="com.ziroom.minsu.services.evaluate.entity.LandlordEvaluateVo" id="landlordEvaluateListMap" extends="BaseResultMap">
        <result column="content" property="content" jdbcType="VARCHAR" />
        <result column="landlord_satisfied" property="landlordSatisfied" jdbcType="INTEGER" />
        <result column="is_del" property="isDel" jdbcType="INTEGER" />
        <result column="last_modify_date" property="lastModifyDate" jdbcType="TIMESTAMP" />
    </resultMap>
    
      <!--房客评价列表 相关vo-->
    <resultMap type="com.ziroom.minsu.services.evaluate.entity.TenantEvaluateVo" id="tenantEvaluateListMap" extends="BaseResultMap">
         <result column="content" property="content" jdbcType="VARCHAR" />
	    <result column="house_clean" property="houseClean" jdbcType="INTEGER" />
	    <result column="description_match" property="descriptionMatch" jdbcType="INTEGER" />
	    <result column="safety_degree" property="safetyDegree" jdbcType="INTEGER" />
	    <result column="traffic_position" property="trafficPosition" jdbcType="INTEGER" />
	    <result column="cost_performance" property="costPerformance" jdbcType="INTEGER" />
	    <result column="eva_four" property="evaFour" jdbcType="INTEGER" />
	    <result column="eva_five" property="evaFive" jdbcType="INTEGER" />
	    <result column="last_modify_date" property="lastModifyDate" jdbcType="TIMESTAMP" />
	    <result column="is_del" property="isDel" jdbcType="INTEGER" />
    </resultMap>
    
    <!-- 相互评价列表 以房客为主 -->
    <resultMap type="com.ziroom.minsu.services.evaluate.entity.EvaluateBothItemVo" id="evaBothContentMap">
         <result column="eva_user_uid" property="uid" jdbcType="VARCHAR" />
	    <result column="house_fid" property="houseFid" jdbcType="VARCHAR" />
	    <result column="room_fid" property="roomFid" jdbcType="VARCHAR" />
	    <result column="rent_way" property="rentWay" jdbcType="INTEGER" />
	    <result column="lan_content" property="lanContent" jdbcType="VARCHAR" />
	    <result column="ten_content" property="tentContent" jdbcType="VARCHAR" />
	    <result column="lan_reply_content" property="lanReplyContent" jdbcType="VARCHAR" />
	    <result column="last_modify_date" property="inDate" jdbcType="TIMESTAMP" />
    </resultMap>
    
    <!-- 公用评价类封装 -->
    <resultMap type="com.ziroom.minsu.services.evaluate.entity.EvaluateVo" id="evaluateListMap" extends="BaseResultMap">
        <result column="content" property="content" jdbcType="VARCHAR" />
    </resultMap>
   <!-- 带显示状态的评价order-->
    <resultMap type="com.ziroom.minsu.services.evaluate.entity.EvaluateOrderShowVo" id="evaluateOrderShowMap" extends="BaseResultMap">
        <result column="showStatus" property="showStatus" jdbcType="INTEGER" />
    </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    id, fid, order_sn, eva_statu, eva_user_uid, rated_user_uid, eva_user_type, house_fid, 
    room_fid, bed_fid, create_time, last_modify_date,rent_way,order_eva_flag
  </sql>
  
  <sql id="Multi_Column_List" >
    evo.id, evo.fid, evo.order_sn, evo.eva_statu, evo.eva_user_uid, evo.rated_user_uid, evo.eva_user_type, evo.house_fid, 
    evo.room_fid, evo.bed_fid, evo.create_time, evo.last_modify_date,evo.rent_way,evo.order_eva_flag
  </sql>

    <sql id="Base_Show_List" >
        t.id, t.fid, t.order_sn, t.eva_statu, t.eva_user_uid, t.rated_user_uid, t.eva_user_type, t.house_fid,
        t.room_fid, t.bed_fid, t.create_time, t.last_modify_date,t.rent_way,t.order_eva_flag
    </sql>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from t_evaluate_order
    where id = #{id,jdbcType=INTEGER}
  </select>
  
  <!-- 查询房源评价数量    add by jixd-->
  <select id="countHouseEva" resultType="long">
    SELECT 
  	count(1) 
	FROM
  	t_evaluate_order t  
  	INNER JOIN t_evaluate_show sw ON t.fid = sw.eva_order_fid
	WHERE t.`eva_statu` = 4 
  	AND t.`eva_user_type` = 2 
  	AND sw.eva_order_fid IS NOT NULL AND sw.is_del=0 
	<if test="houseFid != null and houseFid != ''">
	AND t.`house_fid` = #{houseFid,jdbcType=VARCHAR} 
	</if>
	<if test="roomFid != null and roomFid != ''">
	AND t.`room_fid` = #{roomFid,jdbcType=VARCHAR}
	</if>
 	AND t.`rent_way` = #{rentWay,jdbcType=INTEGER}
  	
  </select>
  
  <!-- 查询房东被评价数量 ，被评人是房东   add by jixd-->
  <select id="countLanEva" resultType="long">
    SELECT 
  	count(1) 
	FROM
  	t_evaluate_order t 
  	INNER JOIN t_evaluate_show sw ON t.fid = sw.eva_order_fid 
	WHERE t.`rated_user_uid` = #{landlordUid,jdbcType=VARCHAR}
  	AND t.`eva_statu` = 4 
  	AND t.`eva_user_type` = 2 
  	AND sw.eva_order_fid IS NOT NULL AND sw.is_del=0  	
  </select>
  
  <!-- 查询房客对房源的评价以及房东回复   add by jixd-->
  <select id="queryHouseDetailEvaPage" resultMap="evaBothContentMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluatePCRequest" >
  SELECT tent.eva_user_uid,tent.house_fid,tent.room_fid,tent.rent_way,tent.ten_content,land.lan_content,repl.lan_reply_content,tent.last_modify_date 
	FROM (SELECT t1.`order_sn` AS order_sn,t1.`eva_user_uid` as eva_user_uid,t1.`house_fid` as house_fid,t1.`room_fid` as room_fid,t1.`rent_way` as rent_way,ten.content AS ten_content,ten.`last_modify_date` as last_modify_date
		FROM  t_evaluate_order t1 
		INNER JOIN `t_evaluate_show` sw1 ON t1.`fid` = sw1.`eva_order_fid`
		LEFT JOIN `t_tenant_evaluate` ten ON t1.`fid` = ten.eva_order_fid	
	  	WHERE t1.`eva_statu` =4 
	  	AND t1.`eva_user_type` =2
	  	AND sw1.`eva_order_fid` IS NOT NULL AND sw1.`is_del`='0'
	  	AND ten.`content` is not null
	  	<if test="houseFid != null and houseFid != ''">
			AND t1.`house_fid` = #{houseFid,jdbcType=VARCHAR}  
		</if>
		<if test="roomFid != null and roomFid != ''">
			AND t1.`room_fid` = #{roomFid,jdbcType=VARCHAR} 
		</if>
		AND t1.`rent_way` = #{rentWay,jdbcType=INTEGER} 
	) tent  	
	LEFT JOIN ( SELECT t2.`order_sn` AS order_sn,t2.`eva_user_uid` as eva_user_uid,t2.`house_fid` as house_fid,t2.`room_fid` as room_fid,t2.`rent_way` as rent_way,lan.`content` AS lan_content,lan.`last_modify_date` as last_modify_date
		from  t_evaluate_order t2 
		inner JOIN `t_evaluate_show` sw2 ON t2.`fid` = sw2.`eva_order_fid`
		LEFT JOIN t_landlord_evaluate lan ON t2.`fid` = lan.`eva_order_fid`	
	  	where t2.`eva_statu` =4 
	  	AND t2.`eva_user_type` =1
	  	and sw2.`eva_order_fid` is not null and sw2.`is_del`='0'
	  	<if test="houseFid != null and houseFid != ''">
			AND t2.`house_fid` = #{houseFid,jdbcType=VARCHAR}  
		</if>
		<if test="roomFid != null and roomFid != ''">
			AND t2.`room_fid` = #{roomFid,jdbcType=VARCHAR} 
		</if>
		AND t2.`rent_way` = #{rentWay,jdbcType=INTEGER} 
	) land
	ON tent.order_sn = land.order_sn 
	LEFT JOIN ( SELECT t3.`order_sn` AS order_sn,t3.`eva_user_uid` AS eva_user_uid,t3.`house_fid` AS house_fid,t3.`room_fid` AS room_fid,t3.`rent_way` AS rent_way,rep.content AS lan_reply_content,rep.`last_modify_date` AS last_modify_date
		FROM  t_evaluate_order t3 
		<!-- 
		INNER JOIN `t_evaluate_show` sw3 ON t3.`fid` = sw3.`eva_order_fid`
		 -->
		LEFT JOIN `t_landlord_reply` rep ON t3.`fid` = rep.`eva_order_fid`   	
	  	WHERE t3.`eva_user_type` =10
	  	<!-- 
	  	AND  t3.`eva_statu` =4 
	  	AND sw3.`eva_order_fid` IS NOT NULL AND sw3.`is_del`='0'
	  	 -->	  	
		<if test="houseFid != null and houseFid != ''">
			AND t3.`house_fid` = #{houseFid,jdbcType=VARCHAR}  
		</if>
		<if test="roomFid != null and roomFid != ''">
			AND t3.`room_fid` = #{roomFid,jdbcType=VARCHAR} 
		</if>
		AND t3.`rent_way` = #{rentWay,jdbcType=INTEGER} 
	) repl
	ON tent.order_sn = repl.order_sn
  	ORDER BY tent.last_modify_date  DESC
   
  </select>
  
   <!-- 查询房客对房东的评价以及房东回复   add by jixd-->
  <select id="queryLanEvaPage" resultMap="evaBothContentMap"  parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluatePCRequest" >
  
  SELECT tent.eva_user_uid,tent.house_fid,tent.room_fid,tent.rent_way,tent.ten_content,land.lan_content,repl.lan_reply_content,tent.last_modify_date 
	FROM (SELECT t1.`order_sn` AS order_sn,t1.`eva_user_uid` as eva_user_uid,t1.`house_fid` as house_fid,t1.`room_fid` as room_fid,t1.`rent_way` as rent_way,ten.content AS ten_content,ten.`last_modify_date` as last_modify_date
		FROM  t_evaluate_order t1 
		INNER JOIN `t_evaluate_show` sw1 ON t1.`fid` = sw1.`eva_order_fid`
		LEFT JOIN `t_tenant_evaluate` ten ON t1.`fid` = ten.eva_order_fid	
	  	WHERE t1.`eva_statu` =4 
	  	AND t1.`eva_user_type` =2
	  	AND sw1.`eva_order_fid` IS NOT NULL AND sw1.`is_del`='0'
	  	AND ten.`content` is not null
	  	AND t1.`rated_user_uid` = #{landlordUid,jdbcType=VARCHAR} 
	) tent  	
	LEFT JOIN ( SELECT t2.`order_sn` AS order_sn,t2.`eva_user_uid` as eva_user_uid,t2.`house_fid` as house_fid,t2.`room_fid` as room_fid,t2.`rent_way` as rent_way,lan.`content` AS lan_content,lan.`last_modify_date` as last_modify_date
		from  t_evaluate_order t2 
		inner JOIN `t_evaluate_show` sw2 ON t2.`fid` = sw2.`eva_order_fid`
		LEFT JOIN t_landlord_evaluate lan ON t2.`fid` = lan.`eva_order_fid`	
	  	where t2.`eva_statu` =4 
	  	AND t2.`eva_user_type` =1
	  	and sw2.`eva_order_fid` is not null and sw2.`is_del`='0'
	  	AND t2.`eva_user_uid` = #{landlordUid,jdbcType=VARCHAR}  
	) land
	ON tent.order_sn = land.order_sn 
	LEFT JOIN ( SELECT t3.`order_sn` AS order_sn,t3.`eva_user_uid` AS eva_user_uid,t3.`house_fid` AS house_fid,t3.`room_fid` AS room_fid,t3.`rent_way` AS rent_way,rep.content AS lan_reply_content,rep.`last_modify_date` AS last_modify_date
		FROM  t_evaluate_order t3 
		<!-- 
		INNER JOIN `t_evaluate_show` sw3 ON t3.`fid` = sw3.`eva_order_fid`
		 -->
		LEFT JOIN `t_landlord_reply` rep ON t3.`fid` = rep.`eva_order_fid`   	
	  	WHERE t3.`eva_user_type` =10
	  	<!-- 
	  	AND t3.`eva_statu` =4 
	  	AND sw3.`eva_order_fid` IS NOT NULL AND sw3.`is_del`='0'
	  	 -->
		AND t3.`eva_user_uid` = #{landlordUid,jdbcType=VARCHAR} 
	) repl
	ON tent.order_sn = repl.order_sn
  	ORDER BY tent.last_modify_date  DESC
   
  </select>

    <select id="queryByEvaluateRe" resultMap="BaseResultMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest" >
    <!-- 根据fid查询-->
    select 
    <include refid="Base_Column_List" />
    from t_evaluate_order
    where 1=1
    <if test="evaStatu != null and evaStatu != ''">
         AND eva_statu =#{evaStatu,jdbcType=VARCHAR}
     </if>
     <if test="startTime != null and startTime != ''">
         AND create_time &gt;=#{startTime,jdbcType=VARCHAR}
     </if>
      <if test="endTime != null and endTime != ''">
         AND create_time &lt;=#{endTime,jdbcType=VARCHAR}
     </if>
     <if test="orderEvaFlag != null">
       AND order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER}
     </if>
  </select>



    <select id="queryByFid" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!-- 根据fid查询-->
    select 
    <include refid="Base_Column_List" />
    from t_evaluate_order
    where fid = #{fid,jdbcType=VARCHAR}
  </select>
  
   <select id="queryByOrderSn" resultMap="BaseResultMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest" >
    <!-- 根据orderSn查询-->
    select 
    <include refid="Base_Column_List" />
    from t_evaluate_order
    where order_sn = #{orderSn,jdbcType=VARCHAR}
    <if test="evaStatu != null">
        AND eva_statu = #{evaStatu,jdbcType=INTEGER}
	</if>
  </select>

  <select id="queryEvaluateOrderShowByOrderSn" resultMap="evaluateOrderShowMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest" >
    SELECT
    <include refid="Base_Show_List" />,IF(t1.eva_order_fid IS NULL,0,1) AS showStatus
    FROM
    t_evaluate_order t
    LEFT JOIN t_evaluate_show t1
    ON t.`fid` = t1.`eva_order_fid`
    WHERE t.`eva_statu` = 4
    AND t.order_sn =#{orderSn,jdbcType=VARCHAR}
  </select>

  <select  id="queryOtherLanEvaByPage" resultMap="landlordEvaluateListMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
   <!-- 查看其他房东 对 特定用户评价   互评记录才能展示sql - 单独给房东端 M站使用 -->
	  SELECT <include refid="Multi_Column_List" />,lae.`content`,lae.`landlord_satisfied` 
	  
	  FROM `t_evaluate_order` evo  
		INNER JOIN `t_landlord_evaluate` lae 
	    ON evo.`fid` = lae.`eva_order_fid`
		INNER JOIN `t_evaluate_show` sw ON evo.`fid` = sw.`eva_order_fid`
	WHERE  evo.`eva_user_type` = 1   
	AND evo.`eva_statu` = 4
	AND lae.`is_del` = 0
	AND sw.`eva_order_fid` IS NOT NULL AND sw.`is_del`='0'
	<!-- 被评价人uid -->
	<if test="evaUserUid != null and evaUserUid != ''">
        AND evo.`rated_user_uid`=#{evaUserUid,jdbcType=VARCHAR}
	</if>  
	ORDER BY evo.`create_time` desc  
  
  </select>
  <!-- 分页查询房东评价信息 -->
   <select id="queryLandlordEvaluateByPage" resultMap="landlordEvaluateListMap"  >
  
    <!--  查询 与房源快照相关 -->
    select <include refid="Multi_Column_List" />,lae.`content`,lae.`landlord_satisfied` FROM `t_evaluate_order` evo 
    INNER JOIN	 `t_landlord_evaluate` lae 
    ON evo.`fid` = lae.`eva_order_fid`
    WHERE evo.`eva_user_type`= 1
    <!-- 评价状态(1=待审核 2=系统下线 3=人工下线 4=已发布 5=已举报) -->
    <if test="evaStatu != null">
        AND evo.`eva_statu`=#{evaStatu,jdbcType=INTEGER}
	</if>
	<!-- 被评价人uid -->
	<if test="ratedUserUid != null and ratedUserUid != ''">
        AND evo.`rated_user_uid`=#{ratedUserUid,jdbcType=VARCHAR}
	</if>
	<!-- 订单编号 -->
	<if test="orderSn != null and orderSn != ''">
        AND evo.`order_sn`=#{orderSn,jdbcType=VARCHAR}
	</if>
	<!-- 删除状态 -->
	<if test="isDel != null and isDel != ''">
        AND lae.`is_del`=#{isDel,jdbcType=INTEGER}
	</if>
	ORDER BY evo.`create_time` asc
 </select>
 
  <select id="queryByCondition" resultMap="BaseResultMap"  >
    <!-- 条件查询 -->
    select <include refid="Base_Column_List" /> FROM `t_evaluate_order`
     where  1=1
     <if test="orderEvaFlag != null and orderEvaFlag != ''">
       AND order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER}
     </if>
   </select>
  <!-- 分页查询房客价信息 -->
   <select id="queryTenantEvaluateByPage" resultMap="tenantEvaluateListMap"  >
    <!--  查询 与房源快照相关 -->
    select <include refid="Multi_Column_List" />,ten.`content`,ten.`cost_performance`,ten.`description_match`,
     ten.`eva_five`,ten.`eva_four`,ten.`house_clean`,ten.`is_del`,ten.`safety_degree`,
     ten.`traffic_position` FROM `t_evaluate_order` evo 
     INNER JOIN	 `t_tenant_evaluate` ten ON evo.`fid` = ten.`eva_order_fid`
     LEFT JOIN `t_evaluate_show` sw ON evo.`fid` = sw.`eva_order_fid`
      WHERE evo.`eva_user_type`= 2
    <!--评价状态(1=待审核 2=审核失败 3=审核成功) -->
    <if test="evaStatu != null and evaStatu != ''">
        AND evo.`eva_statu`=#{evaStatu,jdbcType=INTEGER}
	</if>
	<!-- 评价人uid(即创建人uid) -->
	<if test="evaUserUid != null and evaUserUid != ''">
        AND evo.`eva_user_uid`=#{evaUserUid,jdbcType=VARCHAR}
	</if>
	<!-- 被评人uid -->
	<if test="ratedUserUid != null and ratedUserUid != ''">
        AND evo.`rated_user_uid`=#{ratedUserUid,jdbcType=VARCHAR}
	</if>
	<!-- 订单编号 -->
	<if test="orderSn != null and orderSn != ''">
        AND evo.`order_sn`=#{orderSn,jdbcType=VARCHAR}
	</if>
	<!-- 房源fid-->
	<if test="houseFid != null and houseFid != ''">
        AND evo.`house_fid`=#{houseFid,jdbcType=VARCHAR}
	</if>
	<!-- 房间fid -->
	<if test="roomFid != null and roomFid != ''">
        AND evo.`room_fid`=#{roomFid,jdbcType=VARCHAR}
	</if>
	<!-- 床fid -->
	<if test="bedFid != null and bedFid != ''">
        AND evo.`bed_fid`=#{bedFid,jdbcType=VARCHAR}
	</if>
	<!-- 删除状态 -->
	<if test="isDel != null">
        AND ten.`is_del`=#{isDel,jdbcType=INTEGER}
	</if>
	<!-- 判断显示状态 -->
	<if test="isShow != null and isShow==1">
		AND sw.`eva_order_fid` IS NOT NULL AND sw.`is_del`='0' 
	</if>
	ORDER BY evo.`create_time` desc
 </select>
 
 
  <select id="queryAllEvaluateByPage" resultMap="evaluateListMap"  >
    <!--  查询所有评价的公共信息 -->
    SELECT <include refid="Base_Column_List"/>, content FROM
    (
      (
          SELECT <include refid="Multi_Column_List"/>, lae.content
          FROM t_evaluate_order evo
          INNER JOIN t_landlord_evaluate lae
          ON evo.fid = lae.eva_order_fid
          WHERE evo.eva_user_type= 1
      )
      UNION
      (
          SELECT <include refid="Multi_Column_List"/>, ten.content
          FROM t_evaluate_order evo
          INNER JOIN t_tenant_evaluate ten ON evo.fid = ten.eva_order_fid
          WHERE evo.eva_user_type= 2
      )
      UNION
      (
          SELECT <include refid="Multi_Column_List"/>, rep.content
          FROM t_evaluate_order evo
          INNER JOIN t_landlord_reply rep ON evo.fid = rep.eva_order_fid
          WHERE evo.eva_user_type= 10
      )   
      
    ) AS eva
    <where>
    <!--评价状态(1=待审核 2=审核失败 3=审核成功) -->
    <if test="evaStatu != null and evaStatu != ''">
        AND eva.eva_statu=#{evaStatu,jdbcType=INTEGER}
	</if>
	<!-- 评价人类型 -->
	<if test="evaUserType != null and evaUserType != ''">
        AND eva.eva_user_type=#{evaUserType,jdbcType=INTEGER}
	</if>
	<!-- 评价人uid(即创建人uid) -->
	<if test="evaUserUid != null and evaUserUid != ''">
        AND eva.eva_user_uid=#{evaUserUid,jdbcType=VARCHAR}
	</if>
	<!-- 被评人uid -->
	<if test="ratedUserUid != null and ratedUserUid != ''">
        AND eva.rated_user_uid=#{ratedUserUid,jdbcType=VARCHAR}
	</if>
	<!-- 房源fid-->
	<if test="houseFid != null and houseFid != ''">
        AND eva.house_fid=#{houseFid,jdbcType=VARCHAR}
	</if>


        <if test="listFid != null and listFid.size > 0">
            AND eva.house_fid in
            <foreach collection="listFid"  item="houseFid" open="(" separator="," close=")">
                #{houseFid,jdbcType=VARCHAR}
            </foreach>
        </if>


	<!-- 房间fid -->
	<if test="roomFid != null and roomFid != ''">
        AND eva.room_fid=#{roomFid,jdbcType=VARCHAR}
	</if>
	<!-- 床fid -->
	<if test="bedFid != null and bedFid != ''">
        AND eva.bed_fid=#{bedFid,jdbcType=VARCHAR}
	</if>
	<!-- 订单编号 -->
	<if test="orderSn != null and orderSn != ''">
        AND eva.order_sn=#{orderSn,jdbcType=VARCHAR}
	</if>
	<!-- 房客对房源的评价 -->
	<if test="content != null and content != ''">
        AND eva.content like CONCAT(#{content,jdbcType=VARCHAR},'%' )

	</if>
	<!-- 房源类型 -->
	<if test="rentWay != null and rentWay != ''">
        AND eva.rent_way =#{rentWay,jdbcType=INTEGER}
	</if>
	<!-- 订单是否已评价 -->
	<if test="orderEvaFlag != null and orderEvaFlag != ''">
        AND eva.order_eva_flag =#{orderEvaFlag,jdbcType=INTEGER}
	</if>
	
	<if test="startTime != null and startTime != ''">
        AND eva.create_time &gt;=#{startTime,jdbcType=TIMESTAMP}
	</if>
	<if test="endTime != null and endTime != ''">
        AND eva.create_time &lt;=#{endTime,jdbcType=TIMESTAMP}
	</if>
    </where>
	ORDER BY eva.create_time desc
 </select>
 
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    delete from t_evaluate_order
    where id = #{id,jdbcType=INTEGER}
  </delete>
 
  <insert id="insert" parameterType="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    insert into t_evaluate_order (id, fid, order_sn, 
      eva_statu, eva_user_uid, rated_user_uid, 
      eva_user_type, house_fid, room_fid, 
      bed_fid, create_time, last_modify_date,rent_way,order_eva_flag
      )
    values (#{id,jdbcType=INTEGER}, #{fid,jdbcType=VARCHAR}, #{orderSn,jdbcType=VARCHAR}, 
      #{evaStatu,jdbcType=INTEGER}, #{evaUserUid,jdbcType=VARCHAR}, #{ratedUserUid,jdbcType=VARCHAR}, 
      #{evaUserType,jdbcType=INTEGER}, #{houseFid,jdbcType=VARCHAR}, #{roomFid,jdbcType=VARCHAR}, 
      #{bedFid,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, #{lastModifyDate,jdbcType=TIMESTAMP}
      , #{rentWay,jdbcType=INTEGER}, #{orderEvaFlag,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    insert into t_evaluate_order
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="fid != null" >
        fid,
      </if>
      <if test="orderSn != null" >
        order_sn,
      </if>
      <if test="evaStatu != null" >
        eva_statu,
      </if>
      <if test="evaUserUid != null" >
        eva_user_uid,
      </if>
      <if test="ratedUserUid != null" >
        rated_user_uid,
      </if>
      <if test="evaUserType != null" >
        eva_user_type,
      </if>
      <if test="houseFid != null" >
        house_fid,
      </if>
      <if test="roomFid != null" >
        room_fid,
      </if>
      <if test="bedFid != null" >
        bed_fid,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="lastModifyDate != null" >
        last_modify_date,
      </if>
       <if test="rentWay != null" >
        rent_way,
      </if>
       <if test="orderEvaFlag != null" >
        order_eva_flag,
      </if>

    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="fid != null" >
        #{fid,jdbcType=VARCHAR},
      </if>
      <if test="orderSn != null" >
        #{orderSn,jdbcType=VARCHAR},
      </if>
      <if test="evaStatu != null" >
        #{evaStatu,jdbcType=INTEGER},
      </if>
      <if test="evaUserUid != null" >
        #{evaUserUid,jdbcType=VARCHAR},
      </if>
      <if test="ratedUserUid != null" >
        #{ratedUserUid,jdbcType=VARCHAR},
      </if>
      <if test="evaUserType != null" >
        #{evaUserType,jdbcType=INTEGER},
      </if>
      <if test="houseFid != null" >
        #{houseFid,jdbcType=VARCHAR},
      </if>
      <if test="roomFid != null" >
        #{roomFid,jdbcType=VARCHAR},
      </if>
      <if test="bedFid != null" >
        #{bedFid,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastModifyDate != null" >
        #{lastModifyDate,jdbcType=TIMESTAMP},
      </if>
        <if test="rentWay != null" >
        #{rentWay,jdbcType=INTEGER},
      </if>
        <if test="orderEvaFlag != null" >
        #{orderEvaFlag,jdbcType=INTEGER},
      </if>

    </trim>
  </insert>
  <!-- 根据fid更新  此时只能更新状态和最后修改时间-->
  <update id="updateByFid" parameterType="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    update t_evaluate_order
    <set >
      <if test="evaStatu != null" >
        eva_statu = #{evaStatu,jdbcType=INTEGER},
      </if>
      <if test="lastModifyDate != null" >
        last_modify_date = #{lastModifyDate,jdbcType=TIMESTAMP},
      </if>
        <if test="orderEvaFlag != null" >
        order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER},
      </if>
    </set>
    WHERE  fid = #{fid}
  </update>
  
   <!--按条件修改-->
  <update id="updateBycondition" parameterType="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    update t_evaluate_order
    <set >
      <if test="evaStatu != null" >
        eva_statu = #{evaStatu,jdbcType=INTEGER},
      </if>
      <if test="lastModifyDate != null" >
        last_modify_date = #{lastModifyDate,jdbcType=TIMESTAMP},
      </if>
        <if test="orderEvaFlag != null" >
        order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER},
      </if>
    </set>
    WHERE  1=1
     <if test="fid != null" >
      AND   fid = #{fid,jdbcType=VARCHAR}
      </if>
       <if test="orderSn != null" >
       AND order_sn = #{orderSn,jdbcType=VARCHAR}
       </if>
       <if test="rentWay != null" >
      AND  rent_way = #{rentWay,jdbcType=INTEGER}
       </if>
        <if test="evaUserType != null" >
       AND eva_user_type = #{evaUserType,jdbcType=INTEGER}
       </if>
       <if test="ratedUserUid != null" >
      AND  rated_user_uid = #{ratedUserUid,jdbcType=VARCHAR}
      </if>
      <if test="houseFid != null" >
      AND  house_fid = #{houseFid,jdbcType=VARCHAR}
      </if>
      <if test="roomFid != null" >
      AND  room_fid = #{roomFid,jdbcType=VARCHAR}
      </if>
      <if test="bedFid != null" >
       AND bed_fid = #{bedFid,jdbcType=VARCHAR}
      </if>
  </update>


  

  <update id="updateByPrimaryKeySelective" parameterType="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    update t_evaluate_order
    <set >
      <if test="fid != null" >
        fid = #{fid,jdbcType=VARCHAR},
      </if>
      <if test="orderSn != null" >
        order_sn = #{orderSn,jdbcType=VARCHAR},
      </if>
      <if test="evaStatu != null" >
        eva_statu = #{evaStatu,jdbcType=INTEGER},
      </if>
      <if test="evaUserUid != null" >
        eva_user_uid = #{evaUserUid,jdbcType=VARCHAR},
      </if>
      <if test="ratedUserUid != null" >
        rated_user_uid = #{ratedUserUid,jdbcType=VARCHAR},
      </if>
      <if test="evaUserType != null" >
        eva_user_type = #{evaUserType,jdbcType=INTEGER},
      </if>
      <if test="houseFid != null" >
        house_fid = #{houseFid,jdbcType=VARCHAR},
      </if>
      <if test="roomFid != null" >
        room_fid = #{roomFid,jdbcType=VARCHAR},
      </if>
      <if test="bedFid != null" >
        bed_fid = #{bedFid,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastModifyDate != null" >
        last_modify_date = #{lastModifyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="evaStatu != null" >
        rent_way = #{rentWay,jdbcType=INTEGER},
      </if>
      <if test="evaStatu != null" >
        order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.ziroom.minsu.entity.evaluate.EvaluateOrderEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 07 11:23:01 CST 2016.
    -->
    update t_evaluate_order
    set fid = #{fid,jdbcType=VARCHAR},
      order_sn = #{orderSn,jdbcType=VARCHAR},
      eva_statu = #{evaStatu,jdbcType=INTEGER},
      eva_user_uid = #{evaUserUid,jdbcType=VARCHAR},
      rated_user_uid = #{ratedUserUid,jdbcType=VARCHAR},
      eva_user_type = #{evaUserType,jdbcType=INTEGER},
      house_fid = #{houseFid,jdbcType=VARCHAR},
      room_fid = #{roomFid,jdbcType=VARCHAR},
      bed_fid = #{bedFid,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      last_modify_date = #{lastModifyDate,jdbcType=TIMESTAMP},
      rent_way = #{rentWay,jdbcType=INTEGER},
       order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER},
    where id = #{id,jdbcType=INTEGER}
  </update>



    <!-- 修改评价中的订单评价状态 -->
    <update id="updateSynOrderEvaFlagByFid"  parameterType = "map">
        update t_evaluate_order
        SET
        order_eva_flag = 1
        WHERE 1=1
        <if test="listFid != null">
            <if test="listFid.size > 0">
                AND fid in
                <foreach collection="listFid"  item="fid" index="index" open="(" separator="," close=")">
                    #{fid,jdbcType=VARCHAR}
                </foreach>
            </if>
        </if>
    </update>


  <!-- 修改评价中的订单评价状态 -->
  <update id="updateOrderEvaFlag"  parameterType = "map">
      update t_evaluate_order 
      SET 
       order_eva_flag = #{orderEvaFlag,jdbcType=INTEGER}
       WHERE 1=1
       <if test="evaUserType !=null and evaUserType !=''">
         AND eva_user_type = #{evaUserType,jdbcType=INTEGER}
       </if>
        <if test="listOrderSn != null">
            <if test="listOrderSn.size > 0">
                  AND order_sn in
                <foreach collection="listOrderSn"  item="orderSn" index="index" open="(" separator="," close=")">
                  #{orderSn,jdbcType=VARCHAR}
                </foreach>
            </if>
        </if>
  </update>
  
   <update id="updateByEvaluateRe"  parameterType = "com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
   <!--  待审核的状态 1 更新状态为已发布4 -->
      update t_evaluate_order 
      SET 
        eva_statu  = 4
       WHERE 1=1
         AND eva_statu = 1
       <!-- 创建时间 -->
        <if test="startTime != null and startTime != ''">
            AND create_time &gt;=#{startTime,jdbcType=VARCHAR}
        </if>
         <if test="endTime != null and endTime != ''">
            AND create_time &lt;=#{endTime,jdbcType=VARCHAR}
        </if>
        <if test="listFid != null">
            <if test="listFid.size > 0">
                  AND fid in
                <foreach collection="listFid"  item="fid" open="(" separator="," close=")">
                    #{fid,jdbcType=VARCHAR}
                </foreach>
            </if>
        </if>
  </update> 

    <!--根据订单号查询评价-->
    <select id="findEvaluateByOrderSn" resultMap="BaseResultMap" parameterType="string">
        SELECT
        <include refid="Base_Column_List" />
        FROM
          t_evaluate_order t
        WHERE t.order_sn = #{orderSn,jdbcType=VARCHAR}
          AND t.eva_statu = 4
    </select>

    <!--根据 查询对应房源的评价订单-->
    <select id="findEvaluateByHouseFid" resultMap="orderResultMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
         SELECT DISTINCT
          a.order_sn
          FROM
          (SELECT
            t.order_sn,
            t.create_time
          FROM
            t_evaluate_order t
          WHERE t.eva_statu = 4
            <if test="houseFid != null and houseFid != ''">
            AND t.house_fid = #{houseFid,jdbcType=VARCHAR}
            </if>
            <if test="roomFid != null and roomFid != ''">
            AND t.room_fid = #{roomFid,jdbcType=VARCHAR}
            </if>
            AND t.rent_way = #{rentWay,jdbcType=INTEGER}
          ORDER BY t.create_time DESC) AS a
    </select>

    <!--查询房客对房源评价数量 包含初评和评价-->
    <select id="countTenToHouseEvaNum" resultType="int" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
        SELECT
        COUNT(1)
        FROM
          t_evaluate_order t
        INNER JOIN t_evaluate_show sw ON t.fid = sw.eva_order_fid
        WHERE t.`eva_statu` = 4
        AND t.`eva_user_type` = 2 
        AND sw.eva_order_fid IS NOT NULL AND sw.is_del=0
        <if test="houseFid != null and houseFid != ''">
            AND t.house_fid = #{houseFid,jdbcType=VARCHAR}
        </if>
        <if test="roomFid != null and roomFid !=''">
            AND t.room_fid = #{roomFid,jdbcType=VARCHAR}
        </if>
            AND t.rent_way = #{rentWay,jdbcType=INTEGER}
    </select>

    <!--查询 房东对房客 or 房客对房东评价数量-->
    <select id="countEvaNum" resultType="int" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
        SELECT
        COUNT(1)
        FROM
          t_evaluate_order t
        INNER JOIN t_evaluate_show sw ON t.fid = sw.eva_order_fid
        WHERE t.`eva_statu` = 4
        AND sw.eva_order_fid IS NOT NULL AND sw.is_del=0
        <if test="evaUserType == 1">
            AND t.`eva_user_type` = 1
        </if>
        <if test="evaUserType == 2">
            AND t.`eva_user_type` = 2 
        </if>
          AND t.`rated_user_uid` = #{ratedUserUid,jdbcType=VARCHAR}
    </select>
    
    <!--查询评价未同步显示设置列表-->
    <select id="listEvaluateUncheckShow" resultMap="BaseResultMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
        SELECT
          t.*
        FROM
          t_evaluate_order t
          LEFT JOIN t_evaluate_show t1
            ON t.`fid` = t1.`eva_order_fid`
        WHERE t.`eva_statu` = 4
          AND t.`eva_user_type` != 10
          AND t1.`eva_order_fid` IS NULL
    </select>
    
    <select id="listAllEvaOrderByCondition" resultMap="BaseResultMap" parameterType="com.ziroom.minsu.services.evaluate.dto.EvaluateRequest">
        SELECT
        <include refid="Base_Column_List" />
        FROM t_evaluate_order
        WHERE 1 = 1
        <if test="orderSn != null" >
            AND order_sn = #{orderSn,jdbcType=VARCHAR}
        </if>
        <if test="houseFid != null" >
            AND  house_fid = #{houseFid,jdbcType=VARCHAR}
        </if>
        <if test="roomFid != null" >
            AND  room_fid = #{roomFid,jdbcType=VARCHAR}
        </if>
        <if test="rentWay != null" >
            AND  rent_way = #{rentWay,jdbcType=INTEGER}
        </if>
        <if test="evaUserType != null" >
            AND eva_user_type = #{evaUserType,jdbcType=INTEGER}
        </if>
        <if test="ratedUserUid != null" >
            AND  rated_user_uid = #{ratedUserUid,jdbcType=VARCHAR}
        </if>
        <if test="evaStatu != null">
            AND  eva_statu = #{evaStatu,jdbcType=INTEGER}
        </if>
        <if test="listFid != null and listFid.size > 0">
                AND fid in
                <foreach collection="listFid"  item="fid" index="index" open="(" separator="," close=")">
                    #{fid,jdbcType=VARCHAR}
                </foreach>
        </if>
    </select>

    <!-- 查询昨天遗漏的评价行为(房东行为成长体系定时任务) -->
    <select id="queryTenantEvaluateForCustomerBehaviorJob" resultMap="tenantEvaluateListMap"  >
        SELECT evo.order_sn,
        evo.eva_user_uid,
        evo.rated_user_uid,
        ten.fid,
        ten.house_clean,
        ten.description_match,
        ten.safety_degree,
        ten.traffic_position,
        ten.cost_performance,
        ten.last_modify_date
        FROM `t_evaluate_order` evo
        INNER JOIN `t_tenant_evaluate` ten ON evo.`fid` = ten.`eva_order_fid`
        WHERE ten.`is_del`= 0
        AND ten.last_modify_date &gt;= #{startTime,jdbcType=VARCHAR}
        AND ten.last_modify_date &lt; #{endTime,jdbcType=VARCHAR}
        <if test="listFid != null and listFid.size > 0">
            AND ten.fid NOT IN
            <foreach collection="listFid" item="fid" index="index" open="(" separator="," close=")">
                #{fid,jdbcType=VARCHAR}
            </foreach>
        </if>
    </select>

</mapper>